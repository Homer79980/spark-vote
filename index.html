<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparkå·¥ä½œå®¤ - å†…éƒ¨æŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root { 
            --spark-blue: #0984e3; 
            --spark-dark: #2d3436; 
            --spark-bg: #f1f2f6; 
            --spark-gold: #fdcb6e;
        }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--spark-bg); margin: 0; padding: 20px; color: var(--spark-dark); }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* æ ‡é¢˜æ ·å¼ */
        .header-box { text-align: center; margin-bottom: 40px; border-bottom: 3px solid var(--spark-blue); padding-bottom: 10px; }
        h1 { margin: 0; color: var(--spark-dark); letter-spacing: 2px; }
        .sub-title { color: var(--spark-blue); font-weight: bold; font-size: 1.1rem; }

        /* ç®¡ç†å‘˜é¢æ¿ */
        #admin-panel { 
            display: none; background: #fff; padding: 25px; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; border-top: 5px solid var(--spark-dark);
        }
        .admin-item { 
            display: flex; gap: 15px; margin-bottom: 15px; align-items: stretch; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 5px; }
        .admin-item input[type="text"] { padding: 10px; border: 1px solid #dfe6e9; border-radius: 4px; width: 90%; }
        
        /* === æ–°å¢ï¼šæ‹–æ‹½ä¸Šä¼ åŒºåŸŸæ ·å¼ === */
        .drop-zone {
            flex: 2;
            border: 2px dashed #b2bec3;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #636e72;
            font-size: 13px;
            cursor: pointer;
            transition: 0.3s;
            background: #fff;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            text-align: center;
            padding: 5px;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--spark-blue);
            background: #e1f5fe;
            color: var(--spark-blue);
        }
        .drop-zone img.preview-thumb {
            height: 100%;
            max-height: 70px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .drop-zone span { pointer-events: none; } /* é˜²æ­¢æ–‡å­—å¹²æ‰°æ‹–æ‹½ */

        /* æŒ‰é’®æ ·å¼ */
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 20px; transition: 0.3s; font-weight: bold; }
        .btn-save { background: var(--spark-dark); color: white; width: 100%; margin-top: 10px; padding: 15px; font-size: 16px; }
        .btn-add { background: var(--spark-blue); color: white; width: 100%; margin-top: 10px; }
        .btn-remove { background: #ff7675; color: white; padding: 0 15px; display: flex; align-items: center; }

        /* æŠ•ç¥¨ç½‘æ ¼ */
        .vote-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; 
        }
        .card { 
            background: white; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.05); transition: 0.4s; 
            position: relative;
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        /* å›¾ç‰‡é¢„è§ˆåŒº */
        .card-img-wrapper { width: 100%; height: 220px; overflow: hidden; cursor: zoom-in; position: relative; background: #eee; }
        .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .card-img-wrapper::after { 
            content: "ğŸ” ç‚¹å‡»æŸ¥çœ‹å¤§å›¾"; position: absolute; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.6); color: white; font-size: 11px; padding: 4px 10px; border-radius: 20px;
        }

        .card-body { padding: 20px; text-align: center; }
        .card-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; display: block; }
        
        /* è¿›åº¦æ¡ */
        .progress-box { height: 8px; background: #eee; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--spark-blue); width: 0%; transition: 1.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .stats { font-size: 0.9rem; color: #636e72; margin-bottom: 20px; font-family: monospace; }

        /* ç‹¬ç«‹æŠ•ç¥¨æŒ‰é’® */
        .vote-action-btn { 
            width: 100%; background: #fff; color: var(--spark-blue); 
            border: 2px solid var(--spark-blue); padding: 12px; border-radius: 4px; 
            font-size: 1rem; text-transform: uppercase;
        }
        .vote-action-btn:hover { background: var(--spark-blue); color: #fff; }

        /* å¤§å›¾é¢„è§ˆæ¨¡æ€æ¡† */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center;
            cursor: zoom-out;
        }
        #modal img { max-width: 95%; max-height: 95%; border: 2px solid white; object-fit: contain; }

        .footer { text-align: center; margin-top: 60px; color: #b2bec3; font-size: 12px; cursor: pointer; padding-bottom: 40px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h1 id="mainTitle">SPARK STUDIO</h1>
        <div class="sub-title">å†…éƒ¨å†³ç­–æŠ•ç¥¨ç³»ç»Ÿ</div>
    </div>

    <div id="admin-panel">
        <h3 style="margin-top:0">ğŸ›  å·¥ä½œå®¤ç®¡ç†åå°</h3>
        <p style="font-size: 12px; color: #999;">æ”¯æŒï¼šç›´æ¥ç²˜è´´æˆªå›¾(Ctrl+V)ã€æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶ã€æˆ–ç‚¹å‡»ä¸Šä¼ ã€‚å›¾ç‰‡å°†è‡ªåŠ¨å‹ç¼©ã€‚</p>
        <div id="admin-list"></div>
        <div class="btn-group">
            <button class="btn-add" onclick="addNewRow()">+ æ–°å¢æŠ•ç¥¨é¡¹</button>
            <button class="btn-save" onclick="saveAll()">ä¿å­˜å¹¶æ›´æ–°çº¿ä¸Š</button>
        </div>
    </div>

    <div class="vote-grid" id="voteGrid"></div>

    <div class="footer" onclick="toggleAdmin()">
        Spark Studio Internal Only | <span id="adminBtn">ç®¡ç†å…¥å£</span>
    </div>
</div>

<div id="modal" onclick="closeModal()">
    <img id="modalImg" src="">
</div>

<script>
    // ==========================================
    // 1. é…ç½®åŒº
    // ==========================================
    const firebaseConfig = {
        databaseURL: "https://playa-dc7ae-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentData = {}; 
    let isAdmin = false;

    // å®æ—¶ç›‘å¬
    db.ref('sparkVote').on('value', (snapshot) => {
        const data = snapshot.val() || { title: "SPARK STUDIO", items: [] };
        currentData = data;
        renderUserView(data.items || []);
        if (isAdmin) renderAdminView(data.items || []);
    });

    // æ¸²æŸ“ç”¨æˆ·è§†å›¾
    function renderUserView(items) {
        const grid = document.getElementById('voteGrid');
        grid.innerHTML = '';
        const totalVotes = items.reduce((sum, item) => sum + (item.votes || 0), 0);

        items.forEach((item, index) => {
            const percent = totalVotes === 0 ? 0 : Math.round((item.votes / totalVotes) * 100);
            
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-img-wrapper" onclick="openModal('${index}')">
                    <img id="img-${index}" src="${item.url || 'https://via.placeholder.com/400x300?text=No+Image'}">
                </div>
                <div class="card-body">
                    <span class="card-name">${item.name || 'æœªå‘½åé¡¹ç›®'}</span>
                    <div class="progress-box"><div class="progress-fill" style="width: ${percent}%"></div></div>
                    <div class="stats">CURRENT: ${item.votes || 0} VOTES (${percent}%)</div>
                    <button class="vote-action-btn" onclick="castVote(${index})">ç¡®è®¤æŠ•é€’</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- å¤§å›¾é¢„è§ˆ ---
    function openModal(index) {
        // ç›´æ¥ä» DOM è·å– srcï¼Œé˜²æ­¢æ•°æ®å»¶è¿Ÿ
        const src = document.getElementById(`img-${index}`).src;
        const modal = document.getElementById('modal');
        document.getElementById('modalImg').src = src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // --- æŠ•ç¥¨åŠŸèƒ½ ---
    function castVote(index) {
        if (localStorage.getItem('spark_voted')) {
            alert("Sparkæˆå‘˜ï¼Œæ¯é¡¹ä»»åŠ¡æ‚¨ä»…èƒ½æŠ•é€’ä¸€æ¬¡ã€‚");
            return;
        }
        db.ref(`sparkVote/items/${index}/votes`).transaction((v) => (v || 0) + 1);
        localStorage.setItem('spark_voted', 'true');
        alert("æŠ•ç¥¨å·²å½•å…¥å·¥ä½œå®¤äº‘ç«¯ã€‚");
    }

    // --- ç®¡ç†åŠŸèƒ½ ---
    function toggleAdmin() {
        if (!isAdmin) {
            if (prompt("Spark Studio èº«ä»½éªŒè¯:") === "123456") { 
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('adminBtn').innerText = "é€€å‡ºç®¡ç†";
                renderAdminView(currentData.items || []);
            }
        } else {
            isAdmin = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('adminBtn').innerText = "ç®¡ç†å…¥å£";
        }
    }

    // --- æ ¸å¿ƒï¼šæ¸²æŸ“å¸¦æ‹–æ‹½åŠŸèƒ½çš„ç®¡ç†åˆ—è¡¨ ---
    function renderAdminView(items) {
        const list = document.getElementById('admin-list');
        list.innerHTML = '';
        items.forEach((item, index) => {
            list.appendChild(createAdminRow(item.name, item.url, index));
        });
    }

    function addNewRow() {
        const list = document.getElementById('admin-list');
        if (list.children.length >= 10) return alert("ä¸ºä¿è¯æ€§èƒ½ï¼Œå»ºè®®æœ€å¤š10é¡¹");
        list.appendChild(createAdminRow('', '', null));
    }

    // åˆ›å»ºç®¡ç†è¡Œçš„ HTML ç»“æ„
    function createAdminRow(name, url, index) {
        const div = document.createElement('div');
        div.className = 'admin-item';
        
        // å¦‚æœæœ‰urlï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾
        const dropZoneContent = url 
            ? `<img src="${url}" class="preview-thumb">` 
            : `<span>ğŸ“· æ‹–å…¥å›¾ç‰‡ / ç²˜è´´ / ç‚¹å‡»</span>`;

        div.innerHTML = `
            <div class="input-group">
                <label style="font-size:12px; color:#aaa; font-weight:bold;">æ–¹æ¡ˆåç§°</label>
                <input type="text" class="edit-name" placeholder="è¯·è¾“å…¥åç§°" value="${name || ''}">
            </div>
            
            <div class="drop-zone" 
                 onclick="this.querySelector('input[type=file]').click()"
                 ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)" 
                 ondrop="handleDrop(event, this)"
                 onpaste="handlePaste(event, this)">
                 
                ${dropZoneContent}
                
                <input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">
                <input type="hidden" class="edit-url" value="${url || ''}">
            </div>

            <button class="btn-remove" onclick="removeRow(this, ${index})">âŒ</button>
        `;
        return div;
    }

    // --- æ‹–æ‹½ä¸å›¾ç‰‡å¤„ç†é€»è¾‘ ---

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e, zone) {
        e.preventDefault();
        zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            processFile(file, zone);
        }
    }

    function handlePaste(e, zone) {
        // é˜»æ­¢é»˜è®¤ç²˜è´´ï¼ˆé¿å…ç²˜è´´æ–‡å­—ï¼‰
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf("image") !== -1) {
                e.preventDefault(); // åªæœ‰æ˜¯å›¾ç‰‡æ—¶æ‰é˜»æ­¢ï¼Œå…è®¸ç²˜è´´çº¯æ–‡æœ¬ï¼ˆå°½ç®¡æˆ‘ä»¬ä¸»è¦æƒ³è¦å›¾ç‰‡ï¼‰
                const file = item.getAsFile();
                processFile(file, zone);
                return;
            }
        }
    }

    function handleFileSelect(e, zone) {
        const file = e.target.files[0];
        if (file) processFile(file, zone);
    }

    // æ ¸å¿ƒï¼šè¯»å– + å‹ç¼©å›¾ç‰‡
    function processFile(file, zone) {
        zone.innerHTML = '<span>å¤„ç†ä¸­...</span>';
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                // åˆ›å»º Canvas è¿›è¡Œå‹ç¼©
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; // é™åˆ¶æœ€å¤§å®½åº¦
                const scaleSize = MAX_WIDTH / img.width;
                
                // å¦‚æœå›¾ç‰‡æœ¬èº«å¾ˆå°ï¼Œå°±ä¸æ”¾å¤§äº†
                const finalWidth = img.width > MAX_WIDTH ? MAX_WIDTH : img.width;
                const finalHeight = img.width > MAX_WIDTH ? img.height * scaleSize : img.height;

                canvas.width = finalWidth;
                canvas.height = finalHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // å‹ç¼©ä¸º JPEG, è´¨é‡ 0.7
                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                
                // æ›´æ–° UI
                zone.innerHTML = `<img src="${base64}" class="preview-thumb">`;
                // é‡æ–°æ’å…¥ file input ä»¥ä¾¿ä¸‹æ¬¡è¿˜èƒ½ç‚¹ï¼Œå¹¶æ’å…¥ hidden value
                zone.insertAdjacentHTML('beforeend', `<input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">`);
                zone.insertAdjacentHTML('beforeend', `<input type="hidden" class="edit-url" value="${base64}">`);
            };
        };
        reader.readAsDataURL(file);
    }

    // --- æ•°æ®ä¿å­˜ä¸åˆ é™¤ ---

    function removeRow(btn, index) {
        // å¦‚æœæ˜¯æ–°åŠ çš„è¡Œï¼ˆindexä¸ºnullï¼‰ï¼Œç›´æ¥åˆ DOM
        if (index === null || index === undefined) {
            btn.parentElement.remove();
        } else {
            if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤æ­¤é¡¹ï¼Ÿ")) {
                let items = [...currentData.items];
                items.splice(index, 1);
                db.ref('sparkVote/items').set(items);
            }
        }
    }

    function saveAll() {
        const rows = document.querySelectorAll('#admin-list .admin-item');
        let newItems = [];
        
        rows.forEach(row => {
            const name = row.querySelector('.edit-name').value.trim();
            // æ³¨æ„ï¼šç°åœ¨ url å­˜å‚¨åœ¨ hidden input ä¸­
            const urlInput = row.querySelector('.edit-url');
            const url = urlInput ? urlInput.value : '';

            if (name && url) {
                // å°è¯•ä¿ç•™æ—§ç¥¨æ•°ï¼šé€šè¿‡åå­—åŒ¹é…ï¼ˆä¸å¤Ÿå®Œç¾ä½†å¤Ÿç”¨ï¼‰ï¼Œæˆ–è€…ç›´æ¥ä¿ç•™0
                // æ›´å¥½çš„é€»è¾‘ï¼šå¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæˆ‘ä»¬å…¶å®æ˜¯è¦†ç›–äº†æ•´ä¸ªæ•°ç»„
                // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šå¦‚æœæ˜¯å®Œå…¨æ–°çš„ï¼Œç¥¨æ•°ä¸º0ï¼›å¦‚æœåªæ˜¯æ”¹äº†åå­—æ²¡æ”¹å›¾ï¼Œä¿ç•™ï¼›
                // å®é™…ä¸Š firebase set ä¼šè¦†ç›–ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°½å¯èƒ½æ‰¾å›ä¹‹å‰çš„ç¥¨æ•°
                
                // ç®€å•çš„æŸ¥æ‰¾é€»è¾‘ï¼šå¦‚æœåœ¨æ—§æ•°æ®é‡Œèƒ½æ‰¾åˆ°ç›¸åŒçš„å›¾ï¼Œå°±ä¿ç•™ç¥¨æ•°
                const oldItem = currentData.items ? currentData.items.find(it => it.url === url) : null;
                const oldVotes = oldItem ? oldItem.votes : 0;
                
                newItems.push({ name: name, url: url, votes: oldVotes });
            }
        });

        if (newItems.length === 0) return alert("è¯·è‡³å°‘å¡«å†™ä¸€é¡¹å®Œæ•´æ•°æ®");

        db.ref('sparkVote/items').set(newItems)
          .then(() => alert("âœ¨ Sparkäº‘ç«¯å·²æˆåŠŸæ›´æ–°ï¼"))
          .catch(err => alert("æ›´æ–°å¤±è´¥: " + err.message));
    }
</script>
</body>
</html>
