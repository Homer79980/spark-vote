<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparkå·¥ä½œå®¤ - å†…éƒ¨æŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root { 
            --spark-bg: #f1f2f6; 
            --spark-dark: #2d3436; 
            --spark-blue: #0984e3;
        }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--spark-bg); margin: 0; padding: 20px; color: var(--spark-dark); }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* æ ‡é¢˜æ ·å¼ */
        .header-box { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #ccc; padding-bottom: 10px; }
        h1 { margin: 0; color: var(--spark-dark); letter-spacing: 2px; }
        .sub-title { color: #666; font-weight: bold; font-size: 1.1rem; }

        /* ç®¡ç†å‘˜é¢æ¿ */
        #admin-panel { 
            display: none; background: #fff; padding: 25px; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; border-top: 5px solid var(--spark-dark);
        }
        
        /* è§„åˆ™è®¾ç½®æ  (æ–°) */
        .config-bar {
            background: #e1f5fe; padding: 15px; border-radius: 6px; margin-bottom: 20px; 
            display: flex; align-items: center; gap: 10px; border: 1px solid #b3e5fc; color: #0277bd;
        }
        .config-bar input { padding: 5px; border-radius: 4px; border: 1px solid #81d4fa; text-align: center; font-weight: bold; color: #0277bd; }

        .admin-item { 
            display: flex; gap: 15px; margin-bottom: 15px; align-items: stretch; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; flex-wrap: wrap; 
        }
        .input-group { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 5px; min-width: 150px; }
        .input-group label { font-size:12px; color:#aaa; font-weight:bold; }
        .admin-item input[type="text"] { padding: 10px; border: 1px solid #dfe6e9; border-radius: 4px; width: 90%; }
        
        /* æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ */
        .drop-zone {
            flex: 2; border: 2px dashed #b2bec3; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: #636e72; font-size: 13px; cursor: pointer; transition: 0.3s; background: #fff; min-height: 80px; min-width: 200px;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #0984e3; background: #e1f5fe; color: #0984e3; }
        .drop-zone img.preview-thumb { height: 100%; max-height: 70px; border-radius: 4px; }

        /* æŒ‰é’®ä½“ç³» */
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 20px; transition: 0.3s; font-weight: bold; }
        .btn-save { background: var(--spark-dark); color: white; width: 100%; margin-top: 10px; padding: 15px; font-size: 16px; }
        .btn-add { background: #0984e3; color: white; width: 100%; margin-top: 10px; }
        .btn-remove { background: #ff7675; color: white; padding: 0 15px; display: flex; align-items: center; justify-content: center; }
        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; display: flex; gap: 10px; }
        .btn-danger { background: #fff; border: 1px solid #fab1a0; color: #d63031; flex: 1; font-size: 12px; }
        .btn-danger:hover { background: #d63031; color: white; }

        /* === æŠ•ç¥¨æ˜¾ç¤ºåŒºåŸŸ === */
        #voteContainer { display: flex; flex-direction: column; gap: 40px; }
        .group-section { animation: fadeIn 0.5s ease; }
        
        /* åŠ¨æ€é¢œè‰²çš„æ ‡é¢˜ */
        .group-title { 
            font-size: 1.5rem; 
            padding: 12px 20px; margin-bottom: 20px; color: var(--spark-dark);
            border-radius: 0 10px 10px 0;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8);
            border-left: 8px solid #ccc; 
        }
        .group-info { display: flex; gap: 10px; align-items: center; }
        .group-status { font-size: 12px; background: rgba(0,0,0,0.1); padding: 4px 10px; border-radius: 20px; color: inherit; font-weight: normal; }

        .vote-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .card { 
            background: white; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.05); transition: 0.4s; 
            position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        .card-img-wrapper { width: 100%; height: 200px; overflow: hidden; cursor: zoom-in; position: relative; background: #eee; }
        .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; display: block; }
        
        .progress-box { height: 8px; background: #eee; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #ccc; width: 0%; transition: 1.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .stats { font-size: 0.85rem; color: #636e72; margin-bottom: 15px; font-family: monospace; }

        .vote-action-btn { 
            width: 100%; background: #fff; color: #333; 
            border: 2px solid #333; padding: 10px; border-radius: 4px; 
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .vote-action-btn:hover { background: #333; color: #fff; }
        /* ç¦ç”¨çŠ¶æ€ï¼šç”¨äºé¢åº¦ç”¨å®Œ */
        .vote-action-btn.disabled { background: #dfe6e9; color: #b2bec3; border-color: #dfe6e9; cursor: not-allowed; pointer-events: none; }
        /* å·²é€‰çŠ¶æ€ï¼šé«˜äº®æ˜¾ç¤º */
        .vote-action-btn.selected { background: #00b894 !important; color: white !important; border-color: #00b894 !important; cursor: default; pointer-events: none; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; cursor: zoom-out; }
        #modal img { max-width: 95%; max-height: 95%; border: 2px solid white; object-fit: contain; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .footer { text-align: center; margin-top: 60px; color: #b2bec3; font-size: 12px; cursor: pointer; padding-bottom: 40px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h1 id="mainTitle">SPARK STUDIO</h1>
        <div class="sub-title">å†…éƒ¨å†³ç­–æŠ•ç¥¨ç³»ç»Ÿ</div>
    </div>

    <div id="admin-panel">
        <h3 style="margin-top:0">ğŸ›  å·¥ä½œå®¤ç®¡ç†åå°</h3>
        
        <div class="config-bar">
            <span>âš™ï¸ <b>æŠ•ç¥¨è§„åˆ™ï¼š</b>æ¯ä¸ªåˆ†ç»„ä¸‹ï¼Œæ¯äººå…è®¸æŠ•</span>
            <input type="number" id="maxVoteInput" min="1" max="99" value="1" style="width: 50px;">
            <span>ç¥¨</span>
            <span style="font-size:12px; opacity:0.7; margin-left:10px;">(è®¾ä¸º1å³ä¸ºå•é€‰ï¼Œ>1ä¸ºå¤šé€‰)</span>
        </div>

        <div id="admin-list"></div>
        <div class="btn-group">
            <button class="btn-add" onclick="addNewRow()">+ æ–°å¢æŠ•ç¥¨é¡¹</button>
            <button class="btn-save" onclick="saveAll()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°çº¿ä¸Š</button>
        </div>
        <div class="danger-zone">
            <button class="btn-danger" onclick="resetAllVotes()">âš ï¸ æ¸…ç©ºæ‰€æœ‰ç¥¨æ•° (å¼€å¯æ–°ä¸€è½®)</button>
            <button class="btn-danger" onclick="deleteAllItems()">ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰é€‰é¡¹</button>
        </div>
    </div>

    <div id="voteContainer"></div>

    <div class="footer" onclick="toggleAdmin()">
        Spark Studio Internal Only | <span id="adminBtn">ç®¡ç†å…¥å£</span>
    </div>
</div>

<div id="modal" onclick="closeModal()">
    <img id="modalImg" src="">
</div>

<script>
    // ==========================================
    // 1. é…ç½®åŒº
    // ==========================================
    const firebaseConfig = {
        databaseURL: "https://playa-dc7ae-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentData = {}; 
    let isAdmin = false;
    let globalMaxVotes = 1; // é»˜è®¤å•é€‰
    
    // é¢„è®¾é…è‰²ç›˜
    const colorPalette = ['#0984e3', '#00b894', '#6c5ce7', '#e17055', '#fdcb6e', '#e84393', '#2d3436', '#00cec9'];
    let groupColorMap = {};

    // å®æ—¶ç›‘å¬
    db.ref('sparkVote').on('value', (snapshot) => {
        const data = snapshot.val() || { items: [], round: 0, maxVotes: 1 };
        currentData = data;
        
        // æ›´æ–°å…¨å±€è§„åˆ™
        globalMaxVotes = data.maxVotes || 1; 

        // æ£€æŸ¥è½®æ¬¡
        checkRoundVersion(data.round || 0);

        renderUserView(data.items || []);
        if (isAdmin) {
            renderAdminView(data.items || []);
            document.getElementById('maxVoteInput').value = globalMaxVotes;
        }
    });

    // ==========================================
    // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šè½®æ¬¡æ§åˆ¶ä¸æœ¬åœ°å­˜å‚¨
    // ==========================================
    function checkRoundVersion(serverRound) {
        const localRound = parseInt(localStorage.getItem('spark_vote_round') || '-1');
        if (serverRound > localRound) {
            localStorage.setItem('spark_vote_round', serverRound);
            localStorage.removeItem('spark_voted_log'); // æ¸…ç©ºå…·ä½“çš„æŠ•ç¥¨è®°å½•
            if (localRound !== -1) alert("ğŸ”” æ–°ä¸€è½®æŠ•ç¥¨å·²å¼€å¯ï¼");
        }
    }

    // è·å–æŸç»„å·²æŠ•çš„æ•°é‡
    function getVotedCount(groupName) {
        const log = JSON.parse(localStorage.getItem('spark_voted_log') || '{}');
        const groupLog = log[groupName] || [];
        return groupLog.length;
    }

    // æ£€æŸ¥æŸé¡¹æ˜¯å¦å·²æŠ•
    function hasVotedItem(groupName, index) {
        const log = JSON.parse(localStorage.getItem('spark_voted_log') || '{}');
        const groupLog = log[groupName] || [];
        return groupLog.includes(index);
    }

    // ==========================================
    // 3. ç”¨æˆ·è§†å›¾æ¸²æŸ“ (é€»è¾‘å¤§å‡çº§)
    // ==========================================
    function renderUserView(items) {
        const container = document.getElementById('voteContainer');
        container.innerHTML = '';
        const totalVotes = items.reduce((sum, item) => sum + (item.votes || 0), 0);

        // åˆ†ç»„æ•´ç†
        const groupedItems = {};
        items.forEach((item, index) => {
            const groupName = item.group || 'é»˜è®¤åˆ†ç»„';
            if (!groupedItems[groupName]) groupedItems[groupName] = [];
            groupedItems[groupName].push({ ...item, originalIndex: index });
        });

        // éå†åˆ†ç»„
        Object.keys(groupedItems).forEach((groupName, gIndex) => {
            // è·å–å½“å‰ç”¨æˆ·çš„æŠ•ç¥¨çŠ¶æ€
            const votedCount = getVotedCount(groupName);
            const votesLeft = globalMaxVotes - votedCount;
            const isFull = votesLeft <= 0;

            // é¢œè‰²åˆ†é…
            if (!groupColorMap[groupName]) groupColorMap[groupName] = colorPalette[gIndex % colorPalette.length];
            const themeColor = groupColorMap[groupName];

            // æ„å»ºUI
            const section = document.createElement('div');
            section.className = 'group-section';
            
            // æ ‡é¢˜æ ï¼šæ˜¾ç¤ºå‰©ä½™ç¥¨æ•°
            const showTitle = Object.keys(groupedItems).length > 1 || groupName !== 'é»˜è®¤åˆ†ç»„';
            if (showTitle) {
                let statusText = "";
                if (isFull) {
                    statusText = `<span class="group-status voted">âœ… æœ¬ç»„å·²å®Œæˆ</span>`;
                } else {
                    statusText = `<span class="group-status">å‰©ä½™ç¥¨æ•°: ${votesLeft}</span>`;
                }

                section.innerHTML = `
                    <h2 class="group-title" style="border-left-color: ${themeColor}; background: linear-gradient(90deg, ${themeColor}15, transparent);">
                        <span style="color: ${themeColor}">${groupName}</span> 
                        <div class="group-info">${statusText}</div>
                    </h2>`;
            }

            const grid = document.createElement('div');
            grid.className = 'vote-grid';

            groupedItems[groupName].forEach(item => {
                const percent = totalVotes === 0 ? 0 : Math.round((item.votes / totalVotes) * 100);
                const isSelected = hasVotedItem(groupName, item.originalIndex);

                // æŒ‰é’®é€»è¾‘ï¼š
                // 1. å¦‚æœå·²é€‰ -> æ˜¾ç¤ºâ€œå·²é€‰â€ï¼Œç»¿è‰²
                // 2. å¦‚æœæ²¡é€‰ä½†æ²¡ç¥¨äº† -> ç¦ç”¨ï¼Œæ˜¾ç¤ºâ€œç¥¨æ•°ä¸è¶³â€
                // 3. å¦‚æœæ²¡é€‰ä¸”æœ‰ç¥¨ -> æ­£å¸¸ï¼Œæ˜¾ç¤ºâ€œæŠ•ä¸€ç¥¨â€
                
                let btnClass = "vote-action-btn";
                let btnText = "ğŸ—³ï¸ æŠ•ä»–ä¸€ç¥¨";
                let btnClick = `onclick="castVote(${item.originalIndex}, '${groupName}')"`;
                let btnStyle = `style="border-color:${themeColor}; color:${themeColor}"`;
                
                if (isSelected) {
                    btnClass += " selected";
                    btnText = "âœ… å·²é€‰";
                    btnClick = "";
                    btnStyle = ""; // ä½¿ç”¨CSSä¸­çš„ !important æ ·å¼
                } else if (isFull) {
                    btnClass += " disabled";
                    btnText = "â›” ç»„å†…ç¥¨æ•°å·²æ»¡";
                    btnClick = "";
                    btnStyle = "";
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper" onclick="openModal('${item.originalIndex}')">
                        <img id="img-${item.originalIndex}" src="${item.url || 'https://via.placeholder.com/400x300?text=No+Image'}">
                    </div>
                    <div class="card-body">
                        <div>
                            <span class="card-name">${item.name || 'æœªå‘½åé¡¹ç›®'}</span>
                            <div class="progress-box"><div class="progress-fill" style="width: ${percent}%; background:${themeColor}"></div></div>
                            <div class="stats">${item.votes || 0} ç¥¨ (${percent}%)</div>
                        </div>
                        <button class="${btnClass}" ${btnClick} ${btnStyle}>${btnText}</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            section.appendChild(grid);
            container.appendChild(section);
        });

        if (items.length === 0) container.innerHTML = '<div style="text-align:center; padding:50px; color:#999">æš‚æ— æŠ•ç¥¨é¡¹ç›®</div>';
    }

    // --- æŠ•ç¥¨é€»è¾‘ (æ”¯æŒå¤šé€‰è®¡æ•°) ---
    function castVote(index, groupName) {
        // 1. è¯»å–è®°å½•
        let log = JSON.parse(localStorage.getItem('spark_voted_log') || '{}');
        if (!log[groupName]) log[groupName] = [];

        // 2. éªŒè¯ç¥¨æ•°é™åˆ¶
        if (log[groupName].length >= globalMaxVotes) {
            return alert(`ã€${groupName}ã€‘çš„ç¥¨æ•°å·²ç”¨å°½ï¼\nè§„åˆ™ï¼šæœ¬ç»„æœ€å¤šæŠ• ${globalMaxVotes} ç¥¨ã€‚`);
        }
        
        // 3. éªŒè¯æ˜¯å¦é‡å¤æŠ•åŒä¸€é¡¹
        if (log[groupName].includes(index)) {
            return alert("æ‚¨å·²ç»æŠ•è¿‡è¿™ä¸€é¡¹äº†ï¼");
        }

        // 4. æ‰§è¡ŒæŠ•ç¥¨
        db.ref(`sparkVote/items/${index}/votes`).transaction((v) => (v || 0) + 1);

        // 5. æ›´æ–°æœ¬åœ°è®°å½•
        log[groupName].push(index);
        localStorage.setItem('spark_voted_log', JSON.stringify(log));

        // 6. æˆåŠŸåé¦ˆ
        alert(`ğŸ‰ æŠ•ç¥¨æˆåŠŸï¼\næœ¬ç»„å‰©ä½™ç¥¨æ•°ï¼š${globalMaxVotes - log[groupName].length}`);
    }

    // --- é¢„è§ˆ ---
    function openModal(index) {
        document.getElementById('modalImg').src = document.getElementById(`img-${index}`).src;
        document.getElementById('modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; document.body.style.overflow = 'auto'; }

    // ==========================================
    // 4. ç®¡ç†é€»è¾‘
    // ==========================================
    function toggleAdmin() {
        if (!isAdmin) {
            if (prompt("Spark Studio èº«ä»½éªŒè¯:") === "123456") { 
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('adminBtn').innerText = "é€€å‡ºç®¡ç†";
                renderAdminView(currentData.items || []);
                document.getElementById('maxVoteInput').value = globalMaxVotes; // åŒæ­¥è¾“å…¥æ¡†
            }
        } else {
            isAdmin = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('adminBtn').innerText = "ç®¡ç†å…¥å£";
        }
    }

    function renderAdminView(items) {
        const list = document.getElementById('admin-list');
        list.innerHTML = '';
        items.forEach((item, index) => list.appendChild(createAdminRow(item, index)));
    }
    function addNewRow() {
        const list = document.getElementById('admin-list');
        if (list.children.length >= 100) return alert("å·²è¾¾åˆ°ç³»ç»Ÿæœ€å¤§é™åˆ¶");
        list.appendChild(createAdminRow({}, null));
    }

    function resetAllVotes() {
        const confirmCode = Math.floor(1000 + Math.random() * 9000);
        const userCode = prompt(`âš ï¸ å°†æ¸…ç©ºæ‰€æœ‰ç¥¨æ•°å¹¶å¼€å§‹æ–°ä¸€è½®ï¼\nç¡®è®¤ç : ${confirmCode}`);
        if (userCode == confirmCode) {
            const newItems = (currentData.items || []).map(item => ({ ...item, votes: 0 }));
            db.ref('sparkVote').update({
                items: newItems,
                round: (currentData.round || 0) + 1
            }).then(() => alert("âœ… é‡ç½®æˆåŠŸ"));
        }
    }
    function deleteAllItems() { if (confirm("ç¡®å®šæ¸…ç©ºåˆ—è¡¨ï¼Ÿ")) db.ref('sparkVote/items').set([]).then(() => alert("å·²æ¸…ç©º")); }

    function createAdminRow(item, index) {
        const div = document.createElement('div');
        div.className = 'admin-item';
        const dropZoneContent = item.url ? `<img src="${item.url}" class="preview-thumb">` : `<span>ğŸ“· æ‹–å…¥ / ç²˜è´´</span>`;
        div.innerHTML = `
            <div class="input-group" style="flex:0.5; min-width:100px;">
                <label>åˆ†ç»„åç§°</label>
                <input type="text" class="edit-group" placeholder="å¦‚: UIç»„" value="${item.group || ''}">
            </div>
            <div class="input-group">
                <label>é¡¹ç›®åç§°</label>
                <input type="text" class="edit-name" placeholder="åç§°" value="${item.name || ''}">
            </div>
            <div class="drop-zone" 
                 onclick="this.querySelector('input[type=file]').click()"
                 ondragover="event.preventDefault();this.classList.add('drag-over')" 
                 ondragleave="this.classList.remove('drag-over')" 
                 ondrop="handleDrop(event, this)"
                 onpaste="handlePaste(event, this)">
                 ${dropZoneContent}
                <input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">
                <input type="hidden" class="edit-url" value="${item.url || ''}">
            </div>
            <button class="btn-remove" onclick="removeRow(this, ${index})">âŒ</button>
        `;
        return div;
    }

    // å›¾ç‰‡å¤„ç†
    function handleDrop(e, zone) { e.preventDefault(); zone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if(f) processFile(f, zone); }
    function handlePaste(e, zone) { 
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let i of items) if (i.type.indexOf("image") !== -1) { e.preventDefault(); processFile(i.getAsFile(), zone); return; }
    }
    function handleFileSelect(e, zone) { const f = e.target.files[0]; if(f) processFile(f, zone); }
    function processFile(file, zone) {
        zone.innerHTML = '<span>â³...</span>';
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const c = document.createElement('canvas');
                const s = 800 / img.width;
                c.width = img.width > 800 ? 800 : img.width;
                c.height = img.width > 800 ? img.height * s : img.height;
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                const b64 = c.toDataURL('image/jpeg', 0.7);
                zone.innerHTML = `<img src="${b64}" class="preview-thumb">`;
                zone.insertAdjacentHTML('beforeend', `<input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">`);
                zone.insertAdjacentHTML('beforeend', `<input type="hidden" class="edit-url" value="${b64}">`);
            };
        };
        r.readAsDataURL(file);
    }

    function removeRow(btn, index) {
        if (index === null) btn.parentElement.remove();
        else if(confirm("åˆ é™¤æ­¤é¡¹ï¼Ÿ")) {
            let items = [...currentData.items];
            items.splice(index, 1);
            db.ref('sparkVote/items').set(items);
        }
    }

    function saveAll() {
        const rows = document.querySelectorAll('#admin-list .admin-item');
        // è¯»å–æ–°çš„æŠ•ç¥¨è§„åˆ™
        const newMaxVotes = parseInt(document.getElementById('maxVoteInput').value) || 1;
        
        let newItems = [];
        rows.forEach(row => {
            const group = row.querySelector('.edit-group').value.trim() || 'é»˜è®¤åˆ†ç»„';
            const name = row.querySelector('.edit-name').value.trim();
            const url = row.querySelector('.edit-url').value;
            if (name && url) {
                const oldItem = currentData.items ? currentData.items.find(it => it.url === url) : null;
                newItems.push({ name, url, group, votes: oldItem ? oldItem.votes : 0 });
            }
        });
        if (newItems.length === 0 && rows.length > 0) return alert("è¯·å¡«å†™å®Œæ•´");

        // ä¿å­˜itemså’ŒmaxVotes
        db.ref('sparkVote').update({ 
            items: newItems,
            maxVotes: newMaxVotes 
        }).then(() => alert("âœ… ä¿å­˜æˆåŠŸï¼è§„åˆ™å·²æ›´æ–°ä¸º: æ¯ä¸ªåˆ†ç»„é™æŠ• " + newMaxVotes + " ç¥¨"));
    }
</script>
</body>
</html>
