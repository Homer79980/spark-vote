<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparkå·¥ä½œå®¤ - å†…éƒ¨æŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root { 
            --spark-bg: #f1f2f6; 
            --spark-dark: #2d3436; 
        }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--spark-bg); margin: 0; padding: 20px; color: var(--spark-dark); }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* æ ‡é¢˜æ ·å¼ */
        .header-box { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #ccc; padding-bottom: 10px; }
        h1 { margin: 0; color: var(--spark-dark); letter-spacing: 2px; }
        .sub-title { color: #666; font-weight: bold; font-size: 1.1rem; }

        /* ç®¡ç†å‘˜é¢æ¿ */
        #admin-panel { 
            display: none; background: #fff; padding: 25px; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; border-top: 5px solid var(--spark-dark);
        }
        .admin-item { 
            display: flex; gap: 15px; margin-bottom: 15px; align-items: stretch; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; flex-wrap: wrap; 
        }
        .input-group { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 5px; min-width: 150px; }
        .input-group label { font-size:12px; color:#aaa; font-weight:bold; }
        .admin-item input[type="text"] { padding: 10px; border: 1px solid #dfe6e9; border-radius: 4px; width: 90%; }
        
        /* æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ */
        .drop-zone {
            flex: 2; border: 2px dashed #b2bec3; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: #636e72; font-size: 13px; cursor: pointer; transition: 0.3s; background: #fff; min-height: 80px; min-width: 200px;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #0984e3; background: #e1f5fe; color: #0984e3; }
        .drop-zone img.preview-thumb { height: 100%; max-height: 70px; border-radius: 4px; }

        /* æŒ‰é’®ä½“ç³» */
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 20px; transition: 0.3s; font-weight: bold; }
        .btn-save { background: var(--spark-dark); color: white; width: 100%; margin-top: 10px; padding: 15px; font-size: 16px; }
        .btn-add { background: #0984e3; color: white; width: 100%; margin-top: 10px; }
        .btn-remove { background: #ff7675; color: white; padding: 0 15px; display: flex; align-items: center; justify-content: center; }
        
        /* å±é™©æ“ä½œåŒº */
        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; display: flex; gap: 10px; }
        .btn-danger { background: #fff; border: 1px solid #fab1a0; color: #d63031; flex: 1; font-size: 12px; }
        .btn-danger:hover { background: #d63031; color: white; }

        /* === æŠ•ç¥¨æ˜¾ç¤ºåŒºåŸŸ === */
        #voteContainer { display: flex; flex-direction: column; gap: 40px; }
        .group-section { animation: fadeIn 0.5s ease; }
        
        /* åŠ¨æ€é¢œè‰²çš„æ ‡é¢˜ */
        .group-title { 
            font-size: 1.5rem; 
            padding: 12px 20px; margin-bottom: 20px; color: var(--spark-dark);
            border-radius: 0 10px 10px 0;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8);
            border-left: 8px solid #ccc; /* é»˜è®¤è‰²ï¼Œä¼šè¢«JSè¦†ç›– */
        }
        .group-status { font-size: 12px; background: rgba(0,0,0,0.1); padding: 4px 10px; border-radius: 20px; color: inherit; font-weight: normal; }
        .group-status.voted { background: rgba(0,0,0,0.8); color: white; }

        .vote-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .card { 
            background: white; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.05); transition: 0.4s; 
            position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }

        .card-img-wrapper { width: 100%; height: 200px; overflow: hidden; cursor: zoom-in; position: relative; background: #eee; }
        .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { padding: 20px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; display: block; }
        
        .progress-box { height: 8px; background: #eee; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #ccc; width: 0%; transition: 1.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .stats { font-size: 0.85rem; color: #636e72; margin-bottom: 15px; font-family: monospace; }

        .vote-action-btn { 
            width: 100%; background: #fff; color: #333; 
            border: 2px solid #333; padding: 10px; border-radius: 4px; 
            font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .vote-action-btn:hover { background: #333; color: #fff; }
        .vote-action-btn.disabled { background: #dfe6e9; color: #b2bec3; border-color: #dfe6e9; cursor: not-allowed; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; cursor: zoom-out; }
        #modal img { max-width: 95%; max-height: 95%; border: 2px solid white; object-fit: contain; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .footer { text-align: center; margin-top: 60px; color: #b2bec3; font-size: 12px; cursor: pointer; padding-bottom: 40px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h1 id="mainTitle">SPARK STUDIO</h1>
        <div class="sub-title">å†…éƒ¨å†³ç­–æŠ•ç¥¨ç³»ç»Ÿ</div>
    </div>

    <div id="admin-panel">
        <h3 style="margin-top:0">ğŸ›  å·¥ä½œå®¤ç®¡ç†åå°</h3>
        <p style="font-size: 12px; color: #999;">è§„åˆ™ï¼šæ¯ç»„ä¸€äººä¸€ç¥¨ã€‚ä¸Šä¼ æ”¯æŒæ‹–æ‹½ã€‚</p>
        <div id="admin-list"></div>
        <div class="btn-group">
            <button class="btn-add" onclick="addNewRow()">+ æ–°å¢æŠ•ç¥¨é¡¹</button>
            <button class="btn-save" onclick="saveAll()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°çº¿ä¸Š</button>
        </div>
        <div class="danger-zone">
            <button class="btn-danger" onclick="resetAllVotes()">âš ï¸ æ¸…ç©ºç¥¨æ•° (å¼€å¯æ–°ä¸€è½®)</button>
            <button class="btn-danger" onclick="deleteAllItems()">ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰é€‰é¡¹</button>
        </div>
    </div>

    <div id="voteContainer"></div>

    <div class="footer" onclick="toggleAdmin()">
        Spark Studio Internal Only | <span id="adminBtn">ç®¡ç†å…¥å£</span>
    </div>
</div>

<div id="modal" onclick="closeModal()">
    <img id="modalImg" src="">
</div>

<script>
    // ==========================================
    // 1. é…ç½®åŒº
    // ==========================================
    const firebaseConfig = {
        databaseURL: "https://playa-dc7ae-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentData = {}; 
    let isAdmin = false;
    
    // é¢„è®¾é…è‰²ç›˜ (Sparké£æ ¼)
    const colorPalette = [
        '#0984e3', // è“
        '#00b894', // ç»¿
        '#6c5ce7', // ç´«
        '#e17055', // æ©˜çº¢
        '#fdcb6e', // é»„
        '#e84393', // ç²‰
        '#2d3436', // é»‘ç°
        '#00cec9'  // é’
    ];
    // ç¼“å­˜é¢œè‰²ï¼Œé˜²æ­¢åˆ·æ–°æ—¶é¢œè‰²ä¹±è·³
    let groupColorMap = {};

    // å®æ—¶ç›‘å¬
    db.ref('sparkVote').on('value', (snapshot) => {
        const data = snapshot.val() || { title: "SPARK STUDIO", items: [], round: 0 };
        currentData = data;

        // æ ¸å¿ƒï¼šæ£€æŸ¥æŠ•ç¥¨è½®æ¬¡æ˜¯å¦æ›´æ–°
        checkRoundVersion(data.round || 0);

        renderUserView(data.items || []);
        if (isAdmin) renderAdminView(data.items || []);
    });

    // ==========================================
    // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šè½®æ¬¡æ§åˆ¶ (è‡ªåŠ¨é‡ç½®ç”¨æˆ·çŠ¶æ€)
    // ==========================================
    function checkRoundVersion(serverRound) {
        const localRound = parseInt(localStorage.getItem('spark_vote_round') || '-1');
        // å¦‚æœæœåŠ¡å™¨è½®æ¬¡æ¯”æœ¬åœ°å¤§ï¼Œè¯´æ˜ç®¡ç†å‘˜é‡ç½®äº†æŠ•ç¥¨
        if (serverRound > localRound) {
            localStorage.setItem('spark_vote_round', serverRound);
            localStorage.removeItem('spark_voted_groups'); // æ¸…ç©ºæœ¬åœ°è®°å½•
            console.log("æ–°ä¸€è½®æŠ•ç¥¨å¼€å¯ï¼Œæœ¬åœ°è®°å½•å·²é‡ç½®");
            if (localRound !== -1) alert("ğŸ”” ç®¡ç†å‘˜å·²å¼€å¯æ–°ä¸€è½®æŠ•ç¥¨ï¼Œæ‚¨çš„æƒé™å·²é‡ç½®ã€‚");
        }
    }

    // ==========================================
    // 3. ç”¨æˆ·è§†å›¾æ¸²æŸ“ (å«éšæœºé¢œè‰²)
    // ==========================================
    function renderUserView(items) {
        const container = document.getElementById('voteContainer');
        container.innerHTML = '';
        const totalVotes = items.reduce((sum, item) => sum + (item.votes || 0), 0);
        const votedGroups = JSON.parse(localStorage.getItem('spark_voted_groups') || '{}');

        // æ•°æ®åˆ†ç»„
        const groupedItems = {};
        items.forEach((item, index) => {
            const groupName = item.group || 'é»˜è®¤åˆ†ç»„';
            if (!groupedItems[groupName]) groupedItems[groupName] = [];
            groupedItems[groupName].push({ ...item, originalIndex: index });
        });

        // éå†æ¸²æŸ“
        Object.keys(groupedItems).forEach((groupName, gIndex) => {
            const hasVotedThisGroup = votedGroups[groupName] === true;
            
            // --- é¢œè‰²åˆ†é…é€»è¾‘ ---
            if (!groupColorMap[groupName]) {
                // æ ¹æ®ç»„åå“ˆå¸Œæˆ–è€…ç›´æ¥è½®å¾ªåˆ†é…é¢œè‰²
                groupColorMap[groupName] = colorPalette[gIndex % colorPalette.length];
            }
            const themeColor = groupColorMap[groupName];

            // åˆ›å»ºåŒºåŸŸ
            const section = document.createElement('div');
            section.className = 'group-section';
            
            // æ ‡é¢˜
            const showTitle = Object.keys(groupedItems).length > 1 || groupName !== 'é»˜è®¤åˆ†ç»„';
            if (showTitle) {
                const statusBadge = hasVotedThisGroup 
                    ? `<span class="group-status voted">âœ… æœ¬ç»„å·²æŠ•</span>` 
                    : `<span class="group-status">â³ æœ¬ç»„æœªæŠ•</span>`;
                
                // åº”ç”¨é¢œè‰²åˆ°è¾¹æ¡†å’ŒèƒŒæ™¯(æ·¡åŒ–)
                section.innerHTML = `
                    <h2 class="group-title" style="border-left-color: ${themeColor}; background: linear-gradient(90deg, ${themeColor}15, transparent);">
                        <span style="color: ${themeColor}">${groupName}</span> 
                        ${statusBadge}
                    </h2>`;
            }

            // ç½‘æ ¼
            const grid = document.createElement('div');
            grid.className = 'vote-grid';

            groupedItems[groupName].forEach(item => {
                const percent = totalVotes === 0 ? 0 : Math.round((item.votes / totalVotes) * 100);
                const btnClass = hasVotedThisGroup ? "vote-action-btn disabled" : "vote-action-btn";
                const btnText = hasVotedThisGroup ? "æœ¬ç»„å·²å®Œæˆ" : "ğŸ—³ï¸ æŠ•ä»–ä¸€ç¥¨";
                const btnClick = hasVotedThisGroup ? "" : `onclick="castVote(${item.originalIndex}, '${groupName}')"`;
                
                // æŒ‰é’®å’Œè¿›åº¦æ¡è·Ÿéšä¸»é¢˜è‰²
                const btnStyle = hasVotedThisGroup ? "" : `style="border-color:${themeColor}; color:${themeColor}"`;
                const btnHoverStyle = `onmouseover="this.style.background='${themeColor}';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='${themeColor}'"`;

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper" onclick="openModal('${item.originalIndex}')">
                        <img id="img-${item.originalIndex}" src="${item.url || 'https://via.placeholder.com/400x300?text=No+Image'}">
                    </div>
                    <div class="card-body">
                        <div>
                            <span class="card-name">${item.name || 'æœªå‘½åé¡¹ç›®'}</span>
                            <div class="progress-box"><div class="progress-fill" style="width: ${percent}%; background:${themeColor}"></div></div>
                            <div class="stats">${item.votes || 0} ç¥¨ (${percent}%)</div>
                        </div>
                        <button class="${btnClass}" ${btnClick} ${hasVotedThisGroup ? '' : btnStyle} ${hasVotedThisGroup ? '' : btnHoverStyle}>
                            ${btnText}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            section.appendChild(grid);
            container.appendChild(section);
        });

        if (items.length === 0) container.innerHTML = '<div style="text-align:center; padding:50px; color:#999">æš‚æ— æŠ•ç¥¨é¡¹ç›®</div>';
    }

    // --- æŠ•ç¥¨ä¸é¢„è§ˆ ---
    function openModal(index) {
        document.getElementById('modalImg').src = document.getElementById(`img-${index}`).src;
        document.getElementById('modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    function castVote(index, groupName) {
        let votedGroups = JSON.parse(localStorage.getItem('spark_voted_groups') || '{}');
        if (votedGroups[groupName]) return alert(`ã€${groupName}ã€‘æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼`);
        
        db.ref(`sparkVote/items/${index}/votes`).transaction((v) => (v || 0) + 1);
        votedGroups[groupName] = true;
        localStorage.setItem('spark_voted_groups', JSON.stringify(votedGroups));
        alert(`ğŸ‰ æŠ•ç¥¨æˆåŠŸï¼`);
    }

    // ==========================================
    // 4. ç®¡ç†åå°é€»è¾‘ (æ–°å¢æ¸…ç©ºåŠŸèƒ½)
    // ==========================================
    function toggleAdmin() {
        if (!isAdmin) {
            if (prompt("Spark Studio èº«ä»½éªŒè¯:") === "123456") { 
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('adminBtn').innerText = "é€€å‡ºç®¡ç†";
                renderAdminView(currentData.items || []);
            }
        } else {
            isAdmin = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('adminBtn').innerText = "ç®¡ç†å…¥å£";
        }
    }

    function renderAdminView(items) {
        const list = document.getElementById('admin-list');
        list.innerHTML = '';
        items.forEach((item, index) => list.appendChild(createAdminRow(item, index)));
    }
    function addNewRow() {
        const list = document.getElementById('admin-list');
        if (list.children.length >= 100) return alert("å·²è¾¾åˆ°ç³»ç»Ÿæœ€å¤§é™åˆ¶");
        list.appendChild(createAdminRow({}, null));
    }

    // --- å±é™©æ“ä½œï¼šæ¸…ç©ºç¥¨æ•° ---
    function resetAllVotes() {
        const confirmCode = Math.floor(1000 + Math.random() * 9000);
        const userCode = prompt(`âš ï¸ é«˜èƒ½é¢„è­¦ï¼š\nè¿™å°†æ¸…ç©ºæ‰€æœ‰ç¥¨æ•°å¹¶å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·å¼€å¯æ–°ä¸€è½®æŠ•ç¥¨ï¼\n\nç¡®è®¤è¯·è¾“å…¥éªŒè¯ç : ${confirmCode}`);
        
        if (userCode == confirmCode) {
            const newItems = (currentData.items || []).map(item => ({ ...item, votes: 0 }));
            // æ›´æ–° items åŒæ—¶å¢åŠ  round è½®æ¬¡ï¼Œè§¦å‘å®¢æˆ·ç«¯è‡ªåŠ¨é‡ç½® localStorage
            db.ref('sparkVote').update({
                items: newItems,
                round: (currentData.round || 0) + 1
            }).then(() => alert("âœ… å·²é‡ç½®ç¥¨æ•°ï¼Œæ–°ä¸€è½®æŠ•ç¥¨å¼€å§‹ï¼"));
        }
    }

    // --- å±é™©æ“ä½œï¼šåˆ é™¤æ‰€æœ‰ ---
    function deleteAllItems() {
        if (confirm("ğŸ§¨ ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æŠ•ç¥¨é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) {
            db.ref('sparkVote/items').set([])
              .then(() => alert("å·²æ¸…ç©ºæ‰€æœ‰é¡¹ç›®"));
        }
    }

    // å¸¸è§„ç®¡ç†é€»è¾‘
    function createAdminRow(item, index) {
        const div = document.createElement('div');
        div.className = 'admin-item';
        const dropZoneContent = item.url ? `<img src="${item.url}" class="preview-thumb">` : `<span>ğŸ“· æ‹–å…¥å›¾ç‰‡ / ç²˜è´´</span>`;

        div.innerHTML = `
            <div class="input-group" style="flex:0.5; min-width:100px;">
                <label>åˆ†ç»„åç§°</label>
                <input type="text" class="edit-group" placeholder="å¦‚: UIç»„" value="${item.group || ''}">
            </div>
            <div class="input-group">
                <label>é¡¹ç›®åç§°</label>
                <input type="text" class="edit-name" placeholder="åç§°" value="${item.name || ''}">
            </div>
            <div class="drop-zone" 
                 onclick="this.querySelector('input[type=file]').click()"
                 ondragover="event.preventDefault();this.classList.add('drag-over')" 
                 ondragleave="this.classList.remove('drag-over')" 
                 ondrop="handleDrop(event, this)"
                 onpaste="handlePaste(event, this)">
                 ${dropZoneContent}
                <input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">
                <input type="hidden" class="edit-url" value="${item.url || ''}">
            </div>
            <button class="btn-remove" onclick="removeRow(this, ${index})">âŒ</button>
        `;
        return div;
    }

    // å›¾ç‰‡å¤„ç†ç®€å†™
    function handleDrop(e, zone) { e.preventDefault(); zone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if(f) processFile(f, zone); }
    function handlePaste(e, zone) { 
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let i of items) if (i.type.indexOf("image") !== -1) { e.preventDefault(); processFile(i.getAsFile(), zone); return; }
    }
    function handleFileSelect(e, zone) { const f = e.target.files[0]; if(f) processFile(f, zone); }
    function processFile(file, zone) {
        zone.innerHTML = '<span>â³...</span>';
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const c = document.createElement('canvas');
                const s = 800 / img.width;
                c.width = img.width > 800 ? 800 : img.width;
                c.height = img.width > 800 ? img.height * s : img.height;
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                const b64 = c.toDataURL('image/jpeg', 0.7);
                zone.innerHTML = `<img src="${b64}" class="preview-thumb">`;
                zone.insertAdjacentHTML('beforeend', `<input type="file" hidden accept="image/*" onchange="handleFileSelect(event, this.parentElement)">`);
                zone.insertAdjacentHTML('beforeend', `<input type="hidden" class="edit-url" value="${b64}">`);
            };
        };
        r.readAsDataURL(file);
    }

    function removeRow(btn, index) {
        if (index === null || index === undefined) btn.parentElement.remove();
        else if(confirm("åˆ é™¤æ­¤é¡¹ï¼Ÿ")) {
            let items = [...currentData.items];
            items.splice(index, 1);
            db.ref('sparkVote/items').set(items);
        }
    }

    function saveAll() {
        const rows = document.querySelectorAll('#admin-list .admin-item');
        let newItems = [];
        rows.forEach(row => {
            const group = row.querySelector('.edit-group').value.trim() || 'é»˜è®¤åˆ†ç»„';
            const name = row.querySelector('.edit-name').value.trim();
            const url = row.querySelector('.edit-url').value;
            if (name && url) {
                const oldItem = currentData.items ? currentData.items.find(it => it.url === url) : null;
                newItems.push({ name, url, group, votes: oldItem ? oldItem.votes : 0 });
            }
        });
        if (newItems.length === 0 && rows.length > 0) return alert("è¯·å¡«å†™å®Œæ•´");
        // ä¿å­˜æ—¶ä¿ç•™å½“å‰çš„ round
        db.ref('sparkVote').update({ items: newItems }).then(() => alert("âœ… ä¿å­˜æˆåŠŸ"));
    }
</script>
</body>
</html>